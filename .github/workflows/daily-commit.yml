name: Randomized Contributions

on:
  schedule:
    - cron: "0 */3 * * *"   # every 3 hours (UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  randomize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "chiruu-git"
          git config user.email "133848646+chiruu-git@users.noreply.github.com"

      - name: Random delay (0–30 min)
        run: |
          SLEEP=$(( RANDOM % 1800 ))
          echo "Sleeping for $SLEEP seconds..."
          sleep "$SLEEP"

      - name: Decide & make commits
        env:
          BOT_EMAIL: "133848646+chiruu-git@users.noreply.github.com"
        run: |
          set -euo pipefail

          TODAY="$(date -u +%Y-%m-%d)"
          DAY_START="${TODAY}T00:00:00Z"

          mkdir -p .contrib
          TARGET_FILE=".contrib/target-${TODAY}.txt"

          SCHEDULED_HOURS=(0 3 6 9 12 15 18 21)

          # -----------------------------
          # Generate target for the day
          # -----------------------------
          if [ -f "$TARGET_FILE" ]; then
            TARGET="$(cat "$TARGET_FILE" | tr -d '[:space:]')"
            echo "Using existing target: $TARGET"
          else
            WEEKDAY=$(date -u +%u)  # 1=Mon ... 7=Sun

            DAY_ROLL=$(( RANDOM % 100 ))

            if [ "$WEEKDAY" -ge 6 ]; then
              # Weekend → generally lower activity
              MIN_TARGET=0
              MAX_TARGET=3
              DAY_TYPE="WEEKEND"
            else
              if [ "$DAY_ROLL" -lt 50 ]; then
                MIN_TARGET=0
                MAX_TARGET=2
                DAY_TYPE="LOW"
              elif [ "$DAY_ROLL" -lt 85 ]; then
                MIN_TARGET=2
                MAX_TARGET=5
                DAY_TYPE="MEDIUM"
              else
                MIN_TARGET=5
                MAX_TARGET=10
                DAY_TYPE="HIGH"
              fi

              # 5% chance extreme grind day
              EXTREME_ROLL=$(( RANDOM % 100 ))
              if [ "$EXTREME_ROLL" -lt 5 ]; then
                MIN_TARGET=12
                MAX_TARGET=20
                DAY_TYPE="EXTREME"
              fi
            fi

            TARGET=$(( RANDOM % (MAX_TARGET - MIN_TARGET + 1) + MIN_TARGET ))

            echo "$TARGET" > "$TARGET_FILE"
            echo "Today is a $DAY_TYPE day → Target: $TARGET commits"
          fi

          # Safety cap (never exceed 20)
          if [ "$TARGET" -gt 20 ]; then
            TARGET=20
            echo "$TARGET" > "$TARGET_FILE"
          fi

          # -----------------------------
          # Count today's commits
          # -----------------------------
          if git rev-parse --verify HEAD >/dev/null 2>&1; then
            COMMITS_TODAY=$(git log --since="${DAY_START}" --author="$BOT_EMAIL" --pretty=%H | wc -l | tr -d ' ')
          else
            COMMITS_TODAY=0
          fi

          echo "Commits today: $COMMITS_TODAY / $TARGET"

          if [ "$COMMITS_TODAY" -ge "$TARGET" ]; then
            echo "Target reached. Exiting."
            exit 0
          fi

          # -----------------------------
          # Calculate attempts remaining
          # -----------------------------
          CURRENT_HOUR=$(date -u +%H)
          CURRENT_HOUR=${CURRENT_HOUR#0}

          RUNS_REMAINING=0
          for h in "${SCHEDULED_HOURS[@]}"; do
            if [ "$h" -gt "$CURRENT_HOUR" ]; then
              RUNS_REMAINING=$((RUNS_REMAINING + 1))
            fi
          done

          ATTEMPTS_LEFT=$((RUNS_REMAINING + 1))
          COMMITS_LEFT=$((TARGET - COMMITS_TODAY))

          echo "Commits left: $COMMITS_LEFT"
          echo "Attempts left: $ATTEMPTS_LEFT"

          if [ "$COMMITS_LEFT" -le 0 ]; then
            exit 0
          fi

          # If last run, finish remaining commits
          if [ "$ATTEMPTS_LEFT" -le 1 ]; then
            COMMIT_COUNT="$COMMITS_LEFT"
            echo "Last chance → committing remaining $COMMIT_COUNT"
          else
            # Probability = commits_left / attempts_left
            NUM=$(( COMMITS_LEFT * 1000 / ATTEMPTS_LEFT ))
            R=$(( RANDOM % 1000 ))

            if [ "$R" -lt "$NUM" ]; then
              COMMIT_COUNT=1
              echo "Random decision → committing 1 (R=$R < $NUM)"
            else
              echo "Skipping this run (R=$R >= $NUM)"
              exit 0
            fi
          fi

          # -----------------------------
          # Make commits
          # -----------------------------
          for i in $(seq 1 "$COMMIT_COUNT"); do
            ts="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            month="$(date -u +'%Y-%m')"
            file=".contrib/heartbeat-${month}.log"

            echo "$ts random tick #$i" >> "$file"
            git add "$file"

            git commit -m "random: tick $ts ($i/$COMMIT_COUNT) [skip ci]" || true

            sleep $(( RANDOM % 20 ))
          done

      - name: Debug
        run: |
          echo "--- git remote ---"
          git remote -v
          echo "--- branch ---"
          git branch --show-current || true
          echo "--- status ---"
          git status --porcelain || true

      - name: Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          git push origin HEAD:main
